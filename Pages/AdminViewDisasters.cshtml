@page
@model DisasterAlleviation.Pages.AdminViewDisastersModel
@{
    ViewData["Title"] = "View All Disasters";
}

<section class="container py-5">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <!-- Back (left) -->
        <div>
            <a asp-page="/AdminDashboard" class="btn btn-light border rounded-pill px-3 py-1 small fw-semibold text-secondary back-btn">
                <i class="bi bi-arrow-left-circle me-1"></i> Back </a>
        </div>

        <!-- Title -->
        <div class="text-center">
            <h2 class="fw-bold text-primary mb-0">Disaster Management</h2>
            <p class="text-muted small mb-0">Manage registered disasters, allocate resources and assign volunteers.</p>
        </div>

        <!-- Top-right actions -->
        <div class="d-flex gap-2">
            <a asp-page="/AllocateResources" class="btn btn-outline-primary">Allocate Resources</a>
            <a asp-page="/AllocateVolunteers" class="btn btn-outline-success">Allocate Volunteers</a>
            <a asp-page="/RegisterDisaster" class="btn btn-outline-info">Register New Disaster</a>
        </div>
    </div>

    <!-- Filters / search -->
    <div class="row g-2 align-items-center mb-3">
        <div class="col-md-4">
            <input id="searchInput" class="form-control" placeholder="Search by location, type or description..." />
        </div>

        <div class="col-md-2">
            <select id="statusFilter" class="form-select">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Closed">Closed</option>
            </select>
        </div>

        <div class="col-md-3">
            <select id="typeFilter" class="form-select">
                <option value="">All Types</option>
                <option>Flood</option>
                <option>Fire</option>
                <option>Earthquake</option>
                <option>Drought</option>
                <option>Epidemic</option>
                <option>Other</option>
            </select>
        </div>

        <div class="col-md-2">
            <select id="rowsPerPage" class="form-select">
                <option value="0">Show all</option>
                <option value="5">Show 5</option>
                <option value="10" selected>Show 10</option>
                <option value="25">Show 25</option>
            </select>
        </div>

        <div class="col-md-1 text-end">
            <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Clear</button>
        </div>
    </div>

    <!-- Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="disastersTable" class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:50px">#</th>
                            <th class="sortable" data-sort="type">Type</th>
                            <th class="sortable" data-sort="location">Location</th>
                            <th>Description</th>
                            <th class="sortable" data-sort="start">Start Date</th>
                            <th class="sortable" data-sort="end">End Date</th>
                            <th class="sortable" data-sort="status">Status</th>
                            <th style="width:180px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="disastersTbody">
                        @for (int i = 0; i < Model.AllDisasters.Count; i++)
                        {
                            var d = Model.AllDisasters[i];
                            <tr data-id="@d.Id"
                                data-type="@d.TypeOfDisaster"
                                data-location="@d.Location"
                                data-description="@d.Description"
                                data-start="@d.StartDate.ToString("yyyy-MM-dd")"
                                data-end="@(d.EndDate?.ToString("yyyy-MM-dd") ?? "")"
                                data-status="@d.Status">
                                <td>@(i + 1)</td>
                                <td>@d.TypeOfDisaster</td>
                                <td>@d.Location</td>
                                <td class="text-truncate" style="max-width:300px;">@d.Description</td>
                                <td>@d.StartDate.ToString("yyyy-MM-dd")</td>
                                <td>@(d.EndDate?.ToString("yyyy-MM-dd") ?? "—")</td>
                                <td>
                                    <span class="badge @(d.Status == "Active" ? "bg-success" : "bg-secondary")">@d.Status</span>
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm me-1" onclick="viewDetails(@d.Id)"><i class="bi bi-eye"></i> View</button>
                                    @if (d.Status != "Closed")
                                    {
                                        <button class="btn btn-outline-danger btn-sm" onclick="closeDisaster(@d.Id)"><i class="bi bi-x-circle"></i> Close</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- pagination placeholder (simple client-side) -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small" id="tableInfo"></div>
                <nav>
                    <ul id="pagination" class="pagination pagination-sm mb-0"></ul>
                </nav>
            </div>
        </div>
    </div>
</section>

<!-- Modal for details -->
<div class="modal fade" id="disasterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0">
                <h5 id="modalTitle" class="modal-title fw-bold">Disaster Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center text-muted">Loading…</div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script>
        // CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        // Helpers
        const table = document.getElementById('disastersTable');
        const tbody = document.getElementById('disastersTbody');
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const typeFilter = document.getElementById('typeFilter');
        const rowsPerPageSelect = document.getElementById('rowsPerPage');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const paginationContainer = document.getElementById('pagination');
        const tableInfo = document.getElementById('tableInfo');

        // Convert HTMLCollection of rows into array for client-side operations
        function getRows() { return Array.from(tbody.querySelectorAll('tr')); }

        // Apply filters and rendering
        function applyFiltersAndRender(page = 1) {
            const q = searchInput.value.trim().toLowerCase();
            const status = statusFilter.value;
            const type = typeFilter.value;
            const rowsPerPage = parseInt(rowsPerPageSelect.value, 10);
            let rows = getRows();

            // Filter
            rows = rows.filter(r => {
                const typeVal = r.dataset.type?.toLowerCase() ?? '';
                const locVal = r.dataset.location?.toLowerCase() ?? '';
                const descVal = r.dataset.description?.toLowerCase() ?? '';
                const statusVal = r.dataset.status ?? '';

                if (status && statusVal !== status) return false;
                if (type && typeVal !== type.toLowerCase()) return false;
                if (q) {
                    return typeVal.includes(q) || locVal.includes(q) || descVal.includes(q);
                }
                return true;
            });

            // Pagination
            const total = rows.length;
            let perPage = rowsPerPage > 0 ? rowsPerPage : total;
            const totalPages = Math.max(1, Math.ceil(total / perPage));
            page = Math.min(page, totalPages);

            // Hide all rows first
            getRows().forEach(r => r.style.display = 'none');

            // Show the current page rows
            const start = (page - 1) * perPage;
            const end = start + perPage;
            rows.slice(start, end).forEach(r => r.style.display = '');

            renderPagination(totalPages, page);
            tableInfo.innerText = `Showing ${Math.min(total, perPage)} of ${total} result(s) — Page ${page} of ${totalPages}`;
        }

        function renderPagination(totalPages, currentPage) {
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item ' + (i === currentPage ? 'active' : '');
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                paginationContainer.appendChild(li);
            }

            // attach handlers
            paginationContainer.querySelectorAll('a').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const p = parseInt(a.dataset.page, 10);
                    applyFiltersAndRender(p);
                });
            });
        }

        // Sorting
        document.querySelectorAll('th.sortable').forEach(h => {
            h.style.cursor = 'pointer';
            h.addEventListener('click', () => {
                const key = h.dataset.sort;
                toggleSort(key);
            });
        });

        let currentSort = { key: 'created', dir: 'desc' };
        function toggleSort(key) {
            // gather rows and sort them, then re-append to tbody
            const rows = getRows();
            const dir = (currentSort.key === key && currentSort.dir === 'asc') ? 'desc' : 'asc';
            currentSort = { key, dir };

            rows.sort((a, b) => {
                let av = a.dataset[key] ?? '';
                let bv = b.dataset[key] ?? '';

                // If date column, compare as date
                if (key === 'start' || key === 'end') {
                    av = av || '';
                    bv = bv || '';
                    const da = av ? new Date(av) : new Date(0);
                    const db = bv ? new Date(bv) : new Date(0);
                    return dir === 'asc' ? da - db : db - da;
                }

                av = av.toLowerCase();
                bv = bv.toLowerCase();
                if (av < bv) return dir === 'asc' ? -1 : 1;
                if (av > bv) return dir === 'asc' ? 1 : -1;
                return 0;
            });

            // re-append
            rows.forEach(r => tbody.appendChild(r));
            applyFiltersAndRender(1);
        }

        // Close disaster handler (AJAX with CSRF)
        async function closeDisaster(id) {
            const result = await Swal.fire({
                title: "Close Disaster?",
                text: "This will mark the disaster as Closed.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, close it"
            });
            if (!result.isConfirmed) return;

            const resp = await fetch(`?handler=Close&id=${id}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': csrfToken
                }
            });

            if (resp.ok) {
                Swal.fire({ icon: 'success', title: 'Closed', timer: 1400, showConfirmButton: false }).then(() => {
                    // update status cell client-side to Closed
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) {
                        row.dataset.status = 'Closed';
                        row.querySelector('td:nth-child(7) .badge').className = 'badge bg-secondary';
                        row.querySelector('td:nth-child(7) .badge').innerText = 'Closed';
                        // remove Close button
                        const btn = row.querySelector('button[onclick^="closeDisaster"]');
                        if (btn) btn.remove();
                    }
                });
            } else {
                Swal.fire('Error', 'Could not close disaster', 'error');
            }
        }

        // View details handler (AJAX)
        async function viewDetails(id) {
            const resp = await fetch(`?handler=Details&id=${id}`);
            if (!resp.ok) { Swal.fire('Error', 'Unable to load details', 'error'); return; }
            const d = await resp.json();

            const goods = (d.resources || []).filter(r => r.resourceType === "Goods");
            const monetary = (d.resources || []).filter(r => r.resourceType === "Monetary");

            const volunteersHtml = (d.volunteers || []).length
                ? `<ul class="list-group">${(d.volunteers || []).map(v => `<li class="list-group-item"><strong>${escapeHtml(v.fullName)}</strong><br/><small class="text-muted">${escapeHtml(v.email)} • ${escapeHtml(v.phoneNumber ?? '')}</small></li>`).join('')}</ul>`
                : `<div class="text-muted">No volunteers assigned.</div>`;

            const goodsHtml = goods.length ? `<ul class="list-group">${goods.map(r => `<li class="list-group-item">${escapeHtml(r.resourceName)} — ${r.quantity} ${escapeHtml(r.unit ?? '')}</li>`).join('')}</ul>` : `<div class="text-muted small">No goods allocated.</div>`;
            const monetaryHtml = monetary.length ? `<ul class="list-group">${monetary.map(r => `<li class="list-group-item">${escapeHtml(r.resourceName)} — ${r.quantity}</li>`).join('')}</ul>` : `<div class="text-muted small">No monetary resources allocated.</div>`;

            const html = `
                <div>
                    <h5>${escapeHtml(d.typeOfDisaster)} — ${escapeHtml(d.location)} <small class="text-muted">(${escapeHtml(d.status)})</small></h5>
                    <p class="text-muted">${escapeHtml(d.description)}</p>
                    <div class="text-muted small mb-3"><strong>Start:</strong> ${d.startDate?.substring(0,10) ?? '—'} ${d.endDate ? ` • <strong>End:</strong> ${d.endDate.substring(0,10)}` : ''} • <strong>Reported:</strong> ${d.createdAt?.substring(0,10) ?? '—'}</div>
                    <hr/>
                    <h6>Required Aid Types</h6>
                    <div class="mb-3">${escapeHtml(d.requiredAidTypes ?? '—')}</div>
                    <h6>Volunteers</h6>
                    ${volunteersHtml}
                    <h6 class="mt-3">Goods Resources</h6>
                    ${goodsHtml}
                    <h6 class="mt-3">Monetary Resources</h6>
                    ${monetaryHtml}
                </div>
            `;

            document.getElementById('modalTitle').innerText = `Disaster — ${d.location}`;
            document.getElementById('modalBody').innerHTML = html;

            const modalEl = document.getElementById('disasterModal');
            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
        }

        // Prevent XSS in details
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
        }

        // wire up filters
        [searchInput, statusFilter, typeFilter, rowsPerPageSelect].forEach(el => {
            el.addEventListener('change', () => applyFiltersAndRender(1));
            el.addEventListener('input', () => applyFiltersAndRender(1));
        });
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            statusFilter.value = '';
            typeFilter.value = '';
            rowsPerPageSelect.value = '10';
            applyFiltersAndRender(1);
        });

        // initial render
        document.addEventListener('DOMContentLoaded', () => {
            applyFiltersAndRender(1);
        });
    </script>
}
